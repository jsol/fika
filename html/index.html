<html>

<head>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" type="text/css" href="main.css" />

</head>

<body>
    <div id="page-container">
        <div id="main">
            <h2 id="title"></h2>

            <div id="members"></div>

            <div>
                <input type="text" id="identifier"></input>
                <button id="subscribe">Subscribe</button>
            </div>

            <div>
                <button id="unsubscribe">Unsubscribe</button>
            </div>

            <div id="times"></div>
        </div>
        <div id="call-container">
            <input type="time" id="time" step="300"></input>
            <button id="call">Call for Fika</button>
        </div>
    </div>
</body>

</html>


<script>

    async function init() {
        let id
        if (window.location.hash) {
            id = window.location.hash.substr(1)
        } else {
            const res = await fetch('/api/newid')
            const body = await res.json()
            id = body.id
            console.log('ID', body, id)
            window.location.hash = '#' + id
        }

        document.getElementById('title').textContent = 'Fika room: ' + id
        document.title = 'Fika room: ' + id

        const subs = JSON.parse(localStorage.getItem('active-subs')) || {}
        let subscribed = false
        if (subs[id]) {
            document.getElementById('subscribe').parentNode.style.display = 'none'
            document.getElementById('unsubscribe').parentNode.style.display = 'block'
            subscribed = true
        } else {
            document.getElementById('unsubscribe').parentNode.style.display = 'none'
            document.getElementById('subscribe').parentNode.style.display = 'block'
        }

        const res = await fetch(`/api/details/${id}`)
        const body = await res.json()

        const publicKey = body.key
        document.getElementById('time').value = body.lastTime

        const list = document.getElementById('members')
        list.innerHTML = ''
        for (const p of body.participants.sort()) {
            const name = document.createElement('div')
            name.textContent = p
            list.appendChild(name)
        }

        const times = document.getElementById('times')
        times.innerHTML = ''

        for (const t of body.times.sort((a, b) => a.timestamp > b.timestamp)) {
            const occation = document.createElement('div')
            const header = document.createElement('h3')
            header.textContent = new Date(t.timestamp).toLocaleString()
            occation.appendChild(header)
            for (p of t.participants) {
                const participant = document.createElement('div')
                const name = document.createElement('span')
                const icon = document.createElement('img')
                icon.src = p.answer + '.png'
                name.textContent = p.name
                participant.appendChild(icon)
                participant.appendChild(name)
                occation.appendChild(participant)
            }

            if (subscribed) {
                const yes = document.createElement('button')
                const no = document.createElement('button')
                yes.onclick = () => {
                    const uuid = subs[id].id
                    fetch(`/api/calls/${id}/${t.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ answer: 'yes', uuid: uuid })
                    }).then(() => init())
                }
                yes.textContent = 'Yes!'
                no.onclick = () => {
                    const uuid = subs[id].id
                    fetch(`/api/calls/${id}/${t.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ answer: 'no', uuid: uuid })
                    }).then(() => init())
                }
                no.textContent = 'No!'
                occation.appendChild(yes)
                occation.appendChild(no)
            }

            times.appendChild(occation)
        }

        let reg = null
        document.getElementById('subscribe').onclick = () => {
            const name = document.getElementById('identifier').value.replace(/[^a-z0-9]/gmi, ' ').replace(/\s+/g, ' ')

            if (!name) {
                return
            }
            navigator.serviceWorker.ready.then(serviceWorkerRegistration => {
                reg = serviceWorkerRegistration
                return serviceWorkerRegistration.pushManager.getSubscription()
            })
                .then(sub => {
                    if (sub !== null) {
                        return sub
                    }
                    const options = {
                        userVisibleOnly: true,
                        applicationServerKey: publicKey
                    }
                    return reg.pushManager.subscribe(options)
                })
                .then(subscription => {
                    console.log(subscription)
                    // Register with server:
                    const data = {
                        id: id,
                        name: document.getElementById('identifier').value,
                        sub: subscription
                    }
                    return fetch(`/api/subscription/${id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                })
                .then(res => res.json())
                .then(body => {
                    console.log(body)
                    const name = document.createElement('div')
                    name.textContent = body.name
                    list.appendChild(name)

                    const subs = JSON.parse(localStorage.getItem('active-subs')) || {}
                    subs[id] = body
                    localStorage.setItem('active-subs', JSON.stringify(subs))
                    init()
                })

        }

        document.getElementById('call').onclick = () => {
            const time = document.getElementById('time').value
            const data = {
                time: time
            }
            fetch(`/api/subscription/${id}/call`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(res => {
                console.log('SENT')
            })
        }
    }

    init()
    Notification.requestPermission(function (status) {
        console.log('Notification permission status:', status);
    });


    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(function (reg) {

            if (reg.installing) {
                console.log('Service worker installing');
            } else if (reg.waiting) {
                console.log('Service worker installed');
            } else if (reg.active) {
                console.log('Service worker active');
            }

        }).catch(function (error) {
            // registration failed
            console.log('Registration failed with ' + error);
        });
    }

</script>